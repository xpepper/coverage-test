# coverage-test
PoC to collect coverage data from Unit Tests, API tests and QA manual tests.

See https://medium.com/@cjayawickrema/approach-to-calculate-java-code-coverage-with-test-pyramid-30535aff7af5


## Some experiments to try

### 1. Clone the other repo https://github.com/xpepper/jacoco-server:
This repo contains a JaCoCo Server that receives the reports from all the running apps connected to it via a TCP socket. 

### 2. Run the JaCoCo Server

```shell script
$jacoco-server> mvn clean package
$jacoco-server> java -jar target/jacoco-server-1.0-SNAPSHOT-jar-with-dependencies.jar
```
### 3. Run the tests of this application
$coverage-test> mvn clean verify

### 4. Run the application with the JaCoCo agent
This will run the app and connect the JaCoCo agent to the JaCoCo server (which runs on port 6300)

```shell script
$coverage-test> java -javaagent:res/jacocoagent-0.8.6.jar=address=localhost,port=6300,output=tcpclient -jar target/coverage-test-0.0.1-SNAPSHOT.jar
```

### 5. Collect the live metrics of the app
This will merge the local jacoco report generated by the existing unit tests with the jacoco report generated by the live use of the running application:
 
```shell script
$coverage-test> java -jar res/jacococli-0.8.6.jar merge target/jacoco.exec ../jacoco-server/jacoco-server.exec --destfile output/jacoco-final.exec
$coverage-test> java -jar res/jacococli-0.8.6.jar report output/jacoco-final.exec --classfiles target/classes/com --sourcefiles src/main/java/ --html output/jacoco-report
```

You can then try to open the JaCoCo report and see the actual report

```shell script
$coverage-test> open output/jacoco-report/index.html
```

Then, you could try to use the app on different paths and see the coverage changing:

```shell script
$coverage-test> curl -v http://localhost:8080/api/hello
$coverage-test> curl -v http://localhost:8080/api/hello\?age\=23
```

You could run a script that continuously generate the updated report, something like

```shell script
watch -n 5 "java -jar res/jacococli-0.8.6.jar merge target/jacoco.exec ../jacoco-server/jacoco-server.exec --destfile output/jacoco-final.exec && java -jar res/jacococli-0.8.6.jar report output/jacoco-final.exec --classfiles target/classes/com --sourcefiles src/main/java/ --html output/jacoco-report" 
```

## Other Info

To generate the reports we use the JaCoCo cli app, and its `report` command:

```shell script
$coverage-test> java -jar res/jacococli-0.8.6.jar report target/jacoco.exec --classfiles target/classes/com --sourcefiles src/main/java/ --html output/jacoco-report
```
